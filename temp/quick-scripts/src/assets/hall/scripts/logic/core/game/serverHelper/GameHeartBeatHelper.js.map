{"version":3,"sources":["assets\\hall\\scripts\\logic\\core\\game\\serverHelper\\GameHeartBeatHelper.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;AAAA,uDAAkD;AAClD,4CAAuC;AAEvC;IAAiD,uCAAgB;IAAjE;QAAA,qEA2GC;QAzGW,kBAAY,GAAG,CAAC,CAAC;QAEjB,2BAAqB,GAAG,CAAC,CAAC;QAE1B,WAAK,GAAG,KAAK,CAAC;QAEf,iBAAW,GAAG,CAAC,CAAC;QAEvB,OAAO;QACC,kBAAY,GAAG,KAAK,CAAC;QAE7B,MAAM;QACE,kBAAY,GAAG,CAAC,CAAC;;IA6F7B,CAAC;IA3Fa,oCAAM,GAAhB;IAEA,CAAC;IAEM,4CAAc,GAArB;QAEI,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC;IACtB,CAAC;IAEM,2CAAa,GAApB;QAEI,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;IACvB,CAAC;IAGM,2CAAa,GAApB;QAEI,IAAG,IAAI,CAAC,MAAM,CAAC,SAAS,EACxB;YACI,IAAI,GAAG,GAAG,CAAC,CAAC;YACZ,IAAG,CAAC,IAAI,CAAC,YAAY,EACrB;gBACI,GAAG,GAAG,IAAI,CAAC,YAAY,CAAC;gBACxB,IAAI,CAAC,YAAY,EAAE,CAAC;aACvB;YAED,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,SAAS,EAAE,EAAC,MAAM,EAAC,GAAG,EAAC,CAAC,CAAA;SACzD;IACL,CAAC;IAEM,6CAAe,GAAtB,UAAuB,GAAG;QAEtB,IAAI,CAAC,YAAY,GAAG,GAAG,CAAC,MAAM,CAAC,KAAK,IAAI,GAAG,CAAC,MAAM,CAAC,KAAK,CAAC,OAAO,IAAI,CAAC,CAAC;QACtE,IAAI,CAAC,qBAAqB,GAAG,IAAI,CAAC,YAAY,CAAC;IACnD,CAAC;IAEM,iCAAG,GAAV;QAEI,IAAI,CAAC,QAAQ,EAAE,CAAC;QAChB,EAAE,CAAC,IAAI,CAAC,EAAE,CAAC,EAAE,CAAC,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC,QAAQ,EAAE,IAAI,CAAC,CAAC;QACpD,EAAE,CAAC,IAAI,CAAC,EAAE,CAAC,EAAE,CAAC,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,CAAC;QACnD,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,oBAAU,CAAC,4BAA4B,EAAE,IAAI,EAAE,IAAI,CAAC,QAAQ,CAAC,CAAA;IAChF,CAAC;IAEM,mCAAK,GAAZ;QAEI,IAAI,CAAC,QAAQ,EAAE,CAAC;QAChB,EAAE,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC,QAAQ,EAAE,IAAI,CAAC,CAAC;QACrD,EAAE,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,CAAC;QACpD,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,oBAAU,CAAC,4BAA4B,EAAE,IAAI,EAAE,IAAI,CAAC,QAAQ,CAAC,CAAA;QAC7E,IAAI,CAAC,YAAY,GAAG,CAAC,CAAC;QACtB,IAAI,CAAC,cAAc,EAAE,CAAC;IAC1B,CAAC;IAIO,sCAAQ,GAAhB;QAEI,IAAI,CAAC,YAAY,GAAG,KAAK,CAAC;QAC1B,IAAI,CAAC,aAAa,EAAE,CAAC;QACrB,aAAa,CAAC,IAAI,CAAC,WAAW,CAAC,CAAA;IACnC,CAAC;IAEO,qCAAO,GAAf;QAEI,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC;IAC7B,CAAC;IAED,qBAAqB;IACb,sCAAQ,GAAhB;QAEI,IAAI,CAAC,YAAY,GAAG,CAAC,CAAC;IAC1B,CAAC;IAGM,sCAAQ,GAAf,UAAgB,EAAE;QAEd,IAAG,CAAC,IAAI,CAAC,KAAK;YACV,OAAO;QACX,IAAG,CAAC,IAAI,CAAC,MAAM,CAAC,SAAS;YACrB,OAAO;QACX,IAAG,IAAI,CAAC,YAAY,GAAG,CAAC,EACxB;YACI,IAAI,CAAC,YAAY,IAAI,EAAE,CAAC;YACxB,IAAG,IAAI,CAAC,YAAY,IAAI,CAAC,EACzB;gBACI,IAAI,CAAC,aAAa,EAAE,CAAC;gBACrB,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC,qBAAqB,CAAC;aAClD;SACJ;IACL,CAAC;IACL,0BAAC;AAAD,CA3GA,AA2GC,CA3GgD,0BAAgB,GA2GhE","file":"","sourceRoot":"/","sourcesContent":["import BaseServerHelper from \"./BaseServerHelper\";\r\nimport GameServer from \"../GameServer\";\r\n\r\nexport default class GameHeartBeatHelper extends BaseServerHelper\r\n{\r\n    private sendInterval = 0;\r\n\r\n    private lastHeartBeatInterval = 3;\r\n\r\n    private start = false;\r\n\r\n    public netInterval = 0;\r\n\r\n    //是否在后台\r\n    private isBackground = false;\r\n\r\n    //心跳计数\r\n    private heartBeatSeq = 1;\r\n\r\n    protected onInit()\r\n    {\r\n    }\r\n\r\n    public startHeartbeat()\r\n    {\r\n        this.start = true;\r\n    }\r\n\r\n    public stopHeartBeat()\r\n    {\r\n        this.start = false;\r\n    }\r\n\r\n\r\n    public sendHeartBeat()\r\n    {\r\n        if(this.server.isRunning)\r\n        {\r\n            let seq = 0;\r\n            if(!this.isBackground)\r\n            {   \r\n                seq = this.heartBeatSeq;\r\n                this.heartBeatSeq++;\r\n            }\r\n\r\n            this.server.send(Game.Command.HeartBeat, {\"_seq\":seq})\r\n        }\r\n    }\r\n\r\n    public HandleHeartBeat(msg)\r\n    {\r\n        this.sendInterval = msg._param._para && msg._param._para.timeout || 3;\r\n        this.lastHeartBeatInterval = this.sendInterval;\r\n    }\r\n\r\n    public run()\r\n    {\r\n        this.resetSeq();\r\n        cc.game.on(cc.game.EVENT_SHOW, this.onResume, this);\r\n        cc.game.on(cc.game.EVENT_HIDE, this.onPause, this);\r\n        this.server.on(GameServer.Event_GameSocketStartConnect, this, this.resetSeq)\r\n    }\r\n\r\n    public clear()\r\n    {\r\n        this.resetSeq();\r\n        cc.game.off(cc.game.EVENT_SHOW, this.onResume, this);\r\n        cc.game.off(cc.game.EVENT_HIDE, this.onPause, this);\r\n        this.server.off(GameServer.Event_GameSocketStartConnect, this, this.resetSeq)\r\n        this.sendInterval = 0;\r\n        this.startHeartbeat();\r\n    }\r\n\r\n\r\n    private tmpInterval\r\n    private onResume()\r\n    {\r\n        this.isBackground = false;\r\n        this.sendHeartBeat();\r\n        clearInterval(this.tmpInterval)\r\n    }\r\n\r\n    private onPause()\r\n    {\r\n        this.isBackground = true;\r\n    }\r\n\r\n    //默认值为1  0为background\r\n    private resetSeq()\r\n    {\r\n        this.heartBeatSeq = 1;\r\n    }\r\n\r\n\r\n    public onUpdate(dt)\r\n    {\r\n        if(!this.start)\r\n            return;\r\n        if(!this.server.isRunning)\r\n            return;\r\n        if(this.sendInterval > 0)\r\n        {\r\n            this.sendInterval -= dt;\r\n            if(this.sendInterval <= 0)\r\n            {\r\n                this.sendHeartBeat();\r\n                this.sendInterval = this.lastHeartBeatInterval;\r\n            }\r\n        }\r\n    }\r\n}"]}