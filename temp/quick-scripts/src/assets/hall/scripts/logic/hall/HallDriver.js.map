{"version":3,"sources":["assets\\hall\\scripts\\logic\\hall\\HallDriver.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import HallFacade from \"./MVC/HallFacade\";\r\nimport HallSection from \"./HallSection\";\r\nimport SceneManager, { SceneType } from \"../core/scene/SceneManager\";\r\nimport LoadingFacade from \"../core/loadingMVC/LoadingFacade\";\r\nimport AppHelper from \"../core/tool/AppHelper\";\r\nimport PlayerInfoModel from \"../hallcommon/model/PlayerInfoModel\";\r\n\r\n// Learn TypeScript:\r\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/typescript.html\r\n//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/typescript.html\r\n// Learn Attribute:\r\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\r\n//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/reference/attributes.html\r\n// Learn life-cycle callbacks:\r\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\r\n//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/life-cycle-callbacks.html\r\n\r\nconst { ccclass, property } = cc._decorator;\r\n\r\n\r\n@ccclass\r\nexport default class HallDriver extends cc.Component {\r\n\r\n    private hallSectionName = \"hallSection\";\r\n    private startTime = 0;\r\n\r\n\r\n    public requireList =[\r\n    ];\r\n\r\n    public requireAtlasList =[\r\n    ];\r\n\r\n    // 预加载需要动态变换的spine\r\n    public requireGameIconList = [\r\n    ];\r\n\r\n    private dependenceCount = 0;\r\n    //加载条节点\r\n    private loadingNode:cc.Node;\r\n    //tips节点\r\n    private tipNode:cc.Node;\r\n    //预加载类型数量\r\n    private DEPENCE_COUNT = 3;\r\n\r\n    private slider:cc.ProgressBar;\r\n\r\n    //资源是否预加载过\r\n    static PRELOAD_FINISH = false;\r\n    \r\n\r\n    //背景图\r\n    private bg:cc.Sprite;\r\n\r\n    onLoad() {\r\n        this.loadingNode = cc.find(\"loading/loadingBar\", this.node)\r\n        let bgNode = cc.find(\"loading/bg\", this.node)\r\n        if(bgNode)\r\n            this.bg = bgNode.getComponent(cc.Sprite);\r\n        let silderNode = cc.find( \"loading/loadingBar/bar_1_1\", this.node)\r\n        let checkNode = cc.find(\"loading/checkNode\",this.node)\r\n        let checkNodeSprite = null\r\n        let infoLabel = null\r\n        if (checkNode){\r\n            checkNodeSprite = checkNode.getComponent(cc.Sprite)\r\n            let infoLabelNode = checkNode.getChildByName(\"infoLabel\")\r\n            if (infoLabelNode){\r\n                infoLabel = infoLabelNode.getComponent(cc.Label)\r\n            }\r\n            \r\n        }\r\n        if(silderNode)\r\n        {\r\n            this.slider = silderNode.getComponent(cc.ProgressBar);\r\n            this.slider.progress = 0;\r\n        }\r\n        this.sceneSetup();\r\n    }\r\n\r\n    private sceneSetup() {\r\n\r\n        if(window[\"Global\"] == null)\r\n        {\r\n            LoadingFacade.initGlobal();\r\n            Logger.error('Global not init!!!!');\r\n        }\r\n        this.dependenceCount = 0;\r\n        //初始化mvc\r\n        HallFacade.Instance.startUp();\r\n        //初始化section  注册ui  model\r\n        // if (!Global.SectionManager.hasSection(this.hallSectionName)) {\r\n        //     Global.SectionManager.register(this.hallSectionName, new HallSection());\r\n        // }\r\n        // Global.SectionManager.callSectionInit(this.hallSectionName);\r\n        //初始化update驱动  初始化timer\r\n        Global.Component.initDriver();\r\n\r\n        \r\n        cc.game.setFrameRate(Global.Setting.FPSConfig);\r\n\r\n        Global.UI.initUIRoot(!HallDriver.PRELOAD_FINISH);\r\n\r\n\r\n        // Global.Audio.playHallBGM();//xiaoc 2019-10-28 背景音乐的播放在下面的函数中处理PlayerInfoModel.InitBgm();\r\n        this.requireAtlasList = Global.Setting.SkinConfig.requireAtlasList;\r\n        this.requireList = Global.Setting.SkinConfig.requireList;\r\n        this.requireGameIconList = Global.Setting.SkinConfig.requireGameIconList;\r\n\r\n        if (!HallDriver.PRELOAD_FINISH) {\r\n            Global.ResourceManager.releaseHelper.recordUnusedAsset(this.requireGameIconList, null);\r\n            this.updateNodeAcvite();\r\n            this.startTime = Date.now();\r\n            this.preLoadRes();\r\n            //添加常驻节点   防止部分内置资源被删除\r\n            Global.ResourceManager.loadRes(\"hall/effect/notDestroy\", (error, prefab) => {\r\n                if (prefab) {\r\n                    let node = cc.instantiate(prefab);\r\n                    Global.Persist.saveToPool(\"keep\", node);\r\n                }\r\n            })\r\n\r\n            Global.ResourceManager.loadRes(\"hall/prefabs/ui/ChooseRoom/GameLobbyShellUI\", (error, prefab) => {\r\n                if (prefab) {\r\n                    let node = cc.instantiate(prefab);\r\n                    Global.Persist.saveToPool(\"WndGameLobbyShell\", node);\r\n                }\r\n            })\r\n        }\r\n        else {\r\n            this.updateNodeAcvite();\r\n            this.onSceneLoadFinish();\r\n        }\r\n    }\r\n\r\n\r\n\r\n    private updateNodeAcvite()\r\n    {\r\n        //this.loadingNode.active = !HallDriver.PRELOAD_FINISH;\r\n        //this.tipNode.active = HallDriver.PRELOAD_FINISH;\r\n        if (cc.sys.isNative){\r\n            if (this.loadingNode){\r\n                this.loadingNode.active = false;\r\n            }\r\n        }\r\n    }\r\n\r\n    private preLoadRes()\r\n    {\r\n        this.dependenceCount = 0;\r\n        Global.ResourceManager.loadBundleRes(Global.customApp.getHallBundleName(),this.requireGameIconList)\r\n        this.beginLoadAltas();\r\n        this.beginLoadDependence();\r\n        this.beginLoadSpine();\r\n\r\n    }\r\n\r\n    private beginLoadDependence(){\r\n        //显示loading 预加载资源\r\n        if (this.requireList == null || this.requireList.length == 0)\r\n            this.onDependenceLoaded();\r\n        else\r\n            Global.ResourceManager.loadResArr(this.requireList, this.onDependenceLoaded.bind(this), null, null, false, true);\r\n    }\r\n\r\n    private beginLoadAltas(){\r\n        //显示loading 预加载资源\r\n        if (this.requireAtlasList == null || this.requireAtlasList.length == 0)\r\n            this.onAltasLoaded();\r\n        else\r\n            Global.ResourceManager.loadAtlasArr(this.requireAtlasList, this.onAltasLoaded.bind(this));\r\n    }\r\n\r\n    private beginLoadSpine(){\r\n        //显示loading 预加载spine资源\r\n        if (this.requireGameIconList == null || this.requireGameIconList.length == 0)\r\n        {\r\n            this.onAltasLoaded();\r\n        }\r\n        else\r\n        {\r\n            Global.ResourceManager.loadBundleRes(Global.customApp.getHallBundleName(),this.requireGameIconList, this.onAltasLoaded.bind(this))\r\n        }\r\n            // Global.ResourceManager.loadResArr(this.requireGameIconList, this.onAltasLoaded.bind(this), null, null,false, true);\r\n    }\r\n\r\n    private onAltasLoaded() {\r\n        this.dependenceCount++;\r\n        this.checkDependenceAllFinish();\r\n    }\r\n\r\n    private onDependenceLoaded() {\r\n        this.dependenceCount++;\r\n        this.checkDependenceAllFinish();\r\n    }\r\n\r\n    private checkDependenceAllFinish() {\r\n        if (this.dependenceCount >= this.DEPENCE_COUNT) {\r\n            // Logger.error(\"loaded\", Date.now())\r\n            //关闭loading\r\n            // this.currentScene.onLoaded();\r\n            this.onSceneLoadFinish();\r\n        }\r\n    }\r\n\r\n\r\n    private onSceneLoadFinish() {\r\n        //开启写日志\r\n        Global.ReportTool.enableRecord();\r\n\r\n        HallDriver.PRELOAD_FINISH = true;\r\n        if (Global.SceneManager.sceneType == SceneType.Hall) {\r\n            Global.UI.show(\"WndHall\");\r\n            Global.UI.closeHallLoading();\r\n        }\r\n        else if (Global.SceneManager.sceneType == SceneType.Login) {\r\n            Global.UI.show(\"WndLogin\");\r\n        }\r\n\r\n    }\r\n    // update (dt) {}\r\n}\r\n"]}