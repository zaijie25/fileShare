{"version":3,"sources":["assets\\hall\\scripts\\logic\\core\\game\\GameTimeChecker.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["const {ccclass, property} = cc._decorator;\r\n\r\n@ccclass\r\nexport default class GameTimeChecker extends cc.Component{\r\n    private curTimestamp = 0;\r\n    private isTimerRunning = false;\r\n    private lastPauseTime: number;\r\n    private inBackground: boolean;\r\n    private showTime: number;\r\n    private timeError = 1;      // 时间误差 秒级 误差以内直接更新本地时间戳\r\n\r\n    protected onLoad(){\r\n        cc.game.on(cc.game.EVENT_SHOW, this.onResume, this);\r\n        cc.game.on(cc.game.EVENT_HIDE, this.onPause, this);\r\n    }\r\n\r\n    protected onDestroy(){\r\n        cc.game.off(cc.game.EVENT_SHOW, this.onResume, this);\r\n        cc.game.off(cc.game.EVENT_HIDE, this.onPause, this);\r\n        this.stopTimer();\r\n    }\r\n\r\n    /** 游戏协议的时间戳输入用于计算时延 返回ms */\r\n    public correctTime(time: number){\r\n        // Logger.warn(\"correctTime--------------\", time, this.curTimestamp, this.curTimestamp - time);\r\n        if (!this.isTimerRunning || this.curTimestamp == 0)\r\n            return 0;\r\n        let dev =  this.curTimestamp - this.formatTimestamp(time);\r\n        return dev > 0 ? dev : 0;       // 非丢包延时情况，卡在定时器间隔可能会导致负数，取0;\r\n    }\r\n\r\n    /** 心跳的时间戳用于校准本地时间 */\r\n    public checkTimestamp(time: number){\r\n        if (!this.isTimerRunning || this.curTimestamp == 0){\r\n            return this.startTimer(time);\r\n        }\r\n        // Logger.warn(\"checkTimestamp--------------\", this.curTimestamp, time, this.curTimestamp-time);\r\n        // cpu误差会导致负值，卡在定时器刷新临界点\r\n        if (this.curTimestamp - time < this.timeError * 1000){ \r\n            this.curTimestamp = this.formatTimestamp(time);\r\n        }\r\n    }\r\n    \r\n    public startTimer(time: number){\r\n        if (time < 0)\r\n            return;\r\n        this.curTimestamp = this.formatTimestamp(time);\r\n        this.schedule(this.timeRun, 0.1);       // 取0.1s刷新一次时间，避免刷新间隔大产生太大误差\r\n        this.isTimerRunning = true;\r\n    }\r\n\r\n    private timeRun(dt){\r\n        if (!this.isTimerRunning || this.curTimestamp == 0)\r\n            return;\r\n        this.curTimestamp += dt * 1000;\r\n        // Logger.warn(\"timeRun\", dt, this.curTimestamp);\r\n    }\r\n\r\n    public stopTimer(){\r\n        this.unschedule(this.timeRun);\r\n        this.curTimestamp = 0;\r\n        this.isTimerRunning = false;\r\n    }\r\n\r\n    private onPause(){\r\n        if (!this.isTimerRunning)\r\n            return;\r\n        \r\n        this.lastPauseTime = Date.now();\r\n        this.inBackground = true;\r\n    }\r\n\r\n    private onResume(){\r\n        if (!this.isTimerRunning)\r\n            return;\r\n        \r\n        if(!this.inBackground){\r\n            //需要清理上次pause时间，android拉出菜单栏会只出发onresume 有概率不出发onpause (vivo-v1809)\r\n            this.lastPauseTime = 0;\r\n        }\r\n        this.inBackground = false;\r\n\r\n        this.showTime = Date.now();\r\n        if (this.lastPauseTime > 0){\r\n            let backgroundTime = this.showTime - this.lastPauseTime;\r\n            this.curTimestamp += backgroundTime;\r\n            // Logger.warn(\"onResume\", backgroundTime, this.curTimestamp);\r\n        }\r\n    }\r\n\r\n    /** 将时间戳统一转成13位计算 */\r\n    private formatTimestamp(time: number){\r\n        if (time.toString().length == 10){\r\n            return time * 1000;\r\n        }\r\n        return time;\r\n    }\r\n}"]}