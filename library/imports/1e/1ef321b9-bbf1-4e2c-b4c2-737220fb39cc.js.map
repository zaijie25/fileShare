{"version":3,"sources":["assets\\hall\\scripts\\logic\\core\\loadingMVC\\WndDownLoadApkUI.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import WndBase, { DestoryType } from \"../ui/WndBase\";\r\n\r\nexport default class WndDownLoadApkUI extends WndBase {\r\n    private yesBtnNode: cc.Node;\r\n    private noBtnNode: cc.Node;\r\n    private content: cc.Label;\r\n    private yesCallback: Function;\r\n    private noCallback: Function;\r\n    private autoClose = true;\r\n    private autoReleaseFunc = true;\r\n    private loadingBar: cc.Node;\r\n    private downloadApkUrl: string = \"\";\r\n    private downdloadApkName: string = \"appGame.apk\";\r\n    private curPer = 0;\r\n\r\n    protected onInit() {\r\n        this.name = \"WndDownLoadApkUI\";\r\n        this.layer = \"PopLayer\";\r\n        this.resPath = \"hall/prefabs/ui/LoadingScene/DownLoadApkUI\";\r\n        this.destoryType = DestoryType.None;\r\n    }\r\n\r\n    protected initView() {\r\n        this.addCommonClick(\"bg/close\", this.onCloseClick, this);\r\n        this.yesBtnNode = this.addCommonClick(\"yesBtn\", this.onYesBtnClick, this);\r\n        this.noBtnNode = this.addCommonClick(\"noBtn\", this.onCloseClick, this);\r\n        this.content = this.getComponent(\"content\", cc.Label);\r\n        this.content.string = \"\";\r\n\r\n        this.loadingBar = this.getChild(\"loadingBar\")\r\n\r\n    }\r\n\r\n    updateLoadingBar(per: number) {\r\n        if (this.loadingBar == null || !this.loadingBar.isValid)\r\n            return;\r\n        if (per > 1) {\r\n            Logger.error(\"!!!!!!!! per > 1\")\r\n            return;\r\n        }\r\n        let progressNode = this.loadingBar.getChildByName(\"bar_1_1\")\r\n        let progressBar = progressNode.getComponent(cc.ProgressBar)\r\n        progressBar.progress = per\r\n        this.updateLoadingBarStr(Math.round(per * 100) + \"%\")\r\n    }\r\n\r\n    updateLoadingBarStr(str) {\r\n        if (this.loadingBar == null || !this.loadingBar.isValid)\r\n            return;\r\n        let progressPercentLabel = this.loadingBar.getChildByName(\"lbPer\").getComponent(cc.Label)\r\n        progressPercentLabel.string = str\r\n    }\r\n\r\n    /**\r\n     * @param {string} content\r\n     * @param {number} type   1 显示 确定取消  2  显示 确定\r\n     * @param {Function} yesCallback\r\n     * @param {Function} noCallback\r\n     * @param {boolean} autoClose  点击按钮后是否自动关闭界面\r\n     * @memberof WndDownLoadApkUI\r\n     */\r\n    protected onOpen() {\r\n        if (this.args == null || this.args.length == 0) {\r\n            Logger.error(\"没有设置参数\");\r\n            this.close();\r\n            return;\r\n        }\r\n        let content = this.args[0];\r\n        if (content == null || content == \"\") {\r\n            Logger.error(\"没有设置参数\");\r\n            this.close();\r\n            return;\r\n        }\r\n        //1 两个按钮  2 yes 一个按钮\r\n        let type = this.args[1];\r\n        this.updateBtnByType(type);\r\n        this.content.string = content;\r\n        this.downloadApkUrl = this.args[2]\r\n        this.yesCallback = this.args[3];\r\n        this.noCallback = this.args[4];\r\n        this.autoClose = this.args[5] != false;\r\n        this.autoReleaseFunc = this.args[6] != false;\r\n        Global.Event.event(GlobalEvent.FORCE_HIDE_WAITING);\r\n    }\r\n\r\n    private updateBtnByType(type) {\r\n        if (type == 1) {\r\n            this.yesBtnNode.active = true;\r\n            this.noBtnNode.active = true;\r\n            this.yesBtnNode.x = 157;\r\n            this.noBtnNode.x = -157\r\n        }\r\n        else {\r\n            this.yesBtnNode.active = true;\r\n            this.noBtnNode.active = false;\r\n            this.yesBtnNode.x = 0;\r\n        }\r\n    }\r\n\r\n\r\n    private onCloseClick() {\r\n        if (this.autoClose)\r\n            this.close();\r\n\r\n    }\r\n\r\n    protected onClose() {\r\n\r\n    }\r\n\r\n    protected onCloseAnimFinish() {\r\n        if (this.noCallback) {\r\n            //防止嵌套调用\r\n            let tmpnoCallback = this.noCallback;\r\n            if (this.autoReleaseFunc) {\r\n                this.noCallback = null;\r\n            }\r\n            tmpnoCallback();\r\n        }\r\n    }\r\n\r\n    private onYesBtnClick() {\r\n        if (this.yesCallback) {\r\n            this.yesCallback();\r\n            if (this.autoReleaseFunc) {\r\n                this.yesCallback = null;\r\n            }\r\n        }\r\n        if (this.curPer >= 1 || this.curPer >= 1.0) {\r\n            let fullPath = jsb.fileUtils.getWritablePath() + this.downdloadApkName\r\n            //安装apk\r\n            if (jsb.fileUtils.isFileExist(fullPath)) {\r\n                Global.NativeEvent.installApk(fullPath, (retObj) => {\r\n                    if (retObj.result == 0) {\r\n                        Logger.error(\"安装成功！\")\r\n                    } else {\r\n                        Logger.error(\"安装失败!\")\r\n                    }\r\n                })\r\n            }\r\n        } else {\r\n            if (this.curPer == 0 ){\r\n                if (this.downloadApkUrl != null && this.downloadApkUrl != \"\") {\r\n                    this.startAndroidDownLoadApk(this.downloadApkUrl, this.downdloadApkName)\r\n                } else {\r\n                    Global.UI.fastTip(\"下载地址为空！\")\r\n                }\r\n            }else {\r\n                Global.UI.fastTip(\"下载中请稍等！\")\r\n            }\r\n            \r\n        }\r\n    }\r\n\r\n    private startAndroidDownLoadApk(url: string, fileName: string, callback?: Function) {\r\n        let fullPath = jsb.fileUtils.getWritablePath() + fileName\r\n        let apkDownloader = new jsb.Downloader();\r\n        apkDownloader.setOnFileTaskSuccess(() => {\r\n            if (callback) {\r\n                callback(fullPath)\r\n            }\r\n            //安装apk\r\n            if (jsb.fileUtils.isFileExist(fullPath)) {\r\n                Global.NativeEvent.installApk(fullPath, (retObj) => {\r\n                    if (retObj.result == 0) {\r\n                        Logger.error(\"安装成功！\")\r\n                    } else {\r\n                        Logger.error(\"安装失败!\")\r\n                    }\r\n                })\r\n            }\r\n\r\n        });\r\n        apkDownloader.setOnTaskError((obj, errorCode, errorCodeInternal, errorStr) => {\r\n            Logger.error(\"startAndroidDownLoadApk error url = \" + url)\r\n            if (jsb.fileUtils.isFileExist(fullPath)) {\r\n                jsb.fileUtils.removeFile(fullPath)\r\n            }\r\n            this.curPer = 0;\r\n            this.updateLoadingBarStr(\"下载失败，请重试! errorCode \" + errorCode)\r\n        });\r\n\r\n        apkDownloader.setOnTaskProgress((obj, bytesReceived, totalBytesReceived, totalBytesExpected) => {\r\n            // Logger.error(\"bytesReceived = \" + bytesReceived)\r\n            // Logger.error(\"totalBytesReceived = \" + totalBytesReceived)\r\n            // Logger.error(\"totalBytesExpected = \" + totalBytesExpected)\r\n            let per = Number((totalBytesReceived / totalBytesExpected).toFixed(2))\r\n            this.curPer = per;\r\n            this.updateLoadingBar(per)\r\n        })\r\n        apkDownloader.createDownloadFileTask(url, fullPath);//创建下载任务\r\n    }\r\n\r\n\r\n}"]}