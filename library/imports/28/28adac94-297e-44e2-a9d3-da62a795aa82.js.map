{"version":3,"sources":["assets\\hall\\scripts\\logic\\core\\hotUpdate\\component\\GameHotUpdateComponent.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import { ReportTool } from \"../../tool/ReportTool\";\r\n\r\nconst { ccclass, property } = cc._decorator;\r\n\r\n@ccclass\r\nexport default class GameHotUpdateComponent extends cc.Component {\r\n    _comUI: any = null;\r\n    RETRY_INTERVAL = 2;\r\n    _downOverFun: Function = null;\r\n    _gameType: string = '';\r\n    _gameVersion: string = \"\";\r\n    _isBack = 0;\r\n\r\n    manifestUrl = {\r\n        type: cc.Asset,\r\n        default: null\r\n    }\r\n\r\n    _storageManifestUrl = \"\"\r\n    // _customManifestStr = ''\r\n    _updating = false\r\n    _checkedUpd = false\r\n    _canRetry = false\r\n    _storagePath = ''\r\n    _retryTimer: null\r\n    m_downLoadFlag = false    //下载\r\n    m_retryCount = 0         //重试次数\r\n    m_verUrlPath = \"\"\r\n\r\n    _am: jsb.AssetsManager = null;\r\n\r\n    _updateListener = null;\r\n    _checkListener = null;\r\n    localManifestJsonObj: any;\r\n    localManifest: any;\r\n    _gameUpdateUrl: string;\r\n    _download_percent:number = 0 ;//当前下载进度\r\n    startTime:number = 0\r\n    remoteVer:string = \"\"\r\n    totalFileCount:number = 0\r\n    totalByte:number = 0\r\n    totalAssetByte:number = 0\r\n    downLoadType:number = 0\r\n    totalVerifySize = 0\r\n\r\n\r\n    initCheckUpDate(gameType, gameVersion, gameUpdateUrl,remoteVer) {\r\n        // this._downOverFun = fun;\r\n        this._gameType = gameType;\r\n        this._gameVersion = gameVersion;\r\n        this._gameUpdateUrl = gameUpdateUrl;\r\n        this._initUpdData();\r\n        this._newAssetMgr();\r\n        this.remoteVer = remoteVer\r\n        this.downLoadType = gameVersion == \"0.0.0\" ? 0 : 1\r\n        // this.m_downLoadFlag = true;\r\n    }\r\n    _initUpdData() {\r\n        let updateHelper = Global.HotUpdateManager.updateHelper;\r\n        let updUrl = updateHelper.genUrl('', this._gameType) + \"/\" + this._gameVersion\r\n        let prjCfgFile = updateHelper.prjFileName();\r\n        let verCfgFile = updateHelper.verFileName();\r\n        this.m_verUrlPath = updUrl + '/' + verCfgFile;\r\n\r\n        this._storagePath = updateHelper.genStoragePath(this._gameType);\r\n        this._storageManifestUrl = this._storagePath + '/' + prjCfgFile;\r\n\r\n        // Logger.log('storageManifestUrl =============', this._storageManifestUrl)\r\n        // Logger.log('下载URL=======' + this.m_verUrlPath)\r\n\r\n        // this._customManifestStr = JSON.stringify({\r\n        //     \"packageUrl\": updUrl,\r\n        //     \"remoteManifestUrl\": updUrl + \"/\" + prjCfgFile,\r\n        //     \"remoteVersionUrl\": updUrl + \"/\" + verCfgFile,\r\n        //     \"version\": \"0.0.1\",\r\n        //     \"assets\": {},\r\n        //     \"searchPaths\": []\r\n        \r\n        // })\r\n        let context = updateHelper.genStoragePath(this._gameType)\r\n        let fullUrl =  this._gameUpdateUrl + \"/\" + this._gameVersion +\"/\"+ this._gameType + \"/\";\r\n        this.localManifestJsonObj = Global.HotUpdateManager.getManifestObj(fullUrl, context)\r\n        let jsonStr = JSON.stringify(this.localManifestJsonObj)\r\n        // Logger.log(\"----------checkUpdate  jsonStr ========\" + jsonStr)\r\n        this.localManifest = new jsb.Manifest(jsonStr, this._storagePath)\r\n        jsb.fileUtils.writeStringToFile(jsonStr, this._storageManifestUrl)\r\n    }\r\n\r\n\r\n\r\n    /**\r\n     * _newAssetMgr 初始化\r\n     * versionA : 当前版本\r\n     * versionB ：最新版本\r\n     */\r\n    _newAssetMgr() {\r\n        var versionCompareHandle = function (versionA, versionB) {\r\n           // console.log(\"JS 自定义版本比较: version A : \" + versionA + ', version B : ' + versionB);\r\n            return versionA === versionB ? 0 : -1;\r\n        };\r\n        Logger.log('Storage path for remote asset : ' + this._storagePath);\r\n\r\n        if (!cc.sys.isNative) return '';\r\n\r\n        this._am = new jsb.AssetsManager(\"\", this._storagePath, versionCompareHandle);\r\n\r\n        // if (!cc.sys.ENABLE_GC_FOR_NATIVE_OBJECTS) {\r\n        //     //this._am.retain();\r\n        // }\r\n        let self = this\r\n\r\n        this._am.setVerifyCallback(function (path, asset) {\r\n            // Logger.log(\"setVerifyCallback\");\r\n            var compressed = asset.compressed;\r\n            var expectedMD5 = asset.md5;\r\n            var relativePath = asset.path;\r\n            var size = asset.size;\r\n            let fileSize = jsb.fileUtils.getFileSize(path);\r\n            self.totalByte += fileSize\r\n            self.totalFileCount += 1\r\n            self.totalVerifySize += asset.size\r\n            if (compressed) {\r\n                // Logger.log(\"Verification passed : %s \", relativePath);\r\n                return true;\r\n            }\r\n            else {\r\n\r\n                //Logger.log(\"file size = \", fileSize, \"manifest size = \", asset.size);\r\n                return fileSize == asset.size;\r\n                // Logger.log(\"Verification passed : \" + relativePath + ' (' + expectedMD5 + ')');\r\n                // Logger.error(relativePath, path, jsb.fileUtils.getFileSize(path), JSON.stringify(asset));\r\n                // return true;\r\n                // var data = jsb.fileUtils.getDataFromFile(path);\r\n                // if (data == null) {\r\n                //     // Logger.log('data == null MD5 verify fail,path a:' + path + ',path b:' + asset.path + ',md5 b:' + asset.md5);\r\n                //     return false;\r\n                // }\r\n                // var curMD5 = md5(data);\r\n                // if (curMD5 == asset.md5) {\r\n                //     // Logger.log('MD5 verify success!');\r\n                //     return true;\r\n                // }\r\n                // else {\r\n                //     // Logger.log('MD5 verify fail,path a:' + path + ',path b:' + asset.path + ',md5 a:' + curMD5 + ',md5 b:' + asset.md5);\r\n                //     return false;\r\n                // }\r\n            }\r\n        });\r\n\r\n        if (cc.sys.os === cc.sys.OS_ANDROID) {\r\n            this._am.setMaxConcurrentTask(2);\r\n        }\r\n\r\n    }\r\n\r\n\r\n    checkVersionUpdate() {\r\n        if (!cc.sys.isNative) {\r\n            return;\r\n        }\r\n        if (this._updating) {\r\n            Logger.log('checking or updating....')\r\n            return;\r\n        }\r\n        if(!this._gameUpdateUrl)\r\n        {\r\n            Global.Event.event(GlobalEvent.UPDATE_SUB_GAME_FAILED, this._gameType)\r\n            Global.HotUpdateManager.removeHotUpdateGameComp(this._gameType, true)\r\n            return\r\n        }\r\n        this._updating = true;\r\n        this.startTime = new Date().getTime()\r\n        this.totalByte = 0\r\n        this.totalFileCount = 0\r\n        this.m_downLoadFlag = true\r\n        Logger.log('地址: ', Global.HotUpdateManager.updateHelper.genUrl('', this._gameType) + \"/\" + this._gameVersion)\r\n        // Logger.log('checkVersionUpdate customManifestStr =====' + this._customManifestStr)\r\n        if (this._am) {\r\n            if (this._am.getState() === jsb.AssetsManager.State.UNINITED) {\r\n                // if (cc.loader.md5Pipe) {\r\n                //     this.manifestUrl = cc.loader.md5Pipe.transformURL(this.manifestUrl);\r\n                // }\r\n                if (!this.localManifest) {\r\n                    let jsonStr = JSON.stringify(this.localManifestJsonObj)\r\n                    // Logger.log(\"----------checkUpdate  jsonStr ========\" + jsonStr)\r\n                    this.localManifest = new jsb.Manifest(jsonStr, this._storagePath)\r\n                }\r\n\r\n                this._am.loadLocalManifest(this.localManifest, this._storagePath);\r\n            }\r\n            // if (!this._am.getLocalManifest() || !this._am.getLocalManifest().isLoaded()) {\r\n            //     Logger.log('AAAAAA Failed to load local manifest ...')\r\n            //     let manifest = new jsb.Manifest(this._customManifestStr, this._storagePath)\r\n            //     this._am.loadLocalManifest(manifest, this._storagePath)\r\n            // }\r\n            this._am.setEventCallback(this._checkCb.bind(this))\r\n            this._am.checkUpdate();\r\n            \r\n        }\r\n\r\n\r\n    }\r\n\r\n    _checkCb(event) {\r\n        let newVerThere = false;\r\n        let alreadyUpFlag = false;\r\n        let isDownloadFail = false;\r\n        switch (event.getEventCode()) {\r\n            case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\r\n                Logger.log(\"No local manifest file found, hot update skipped.\");\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\r\n            case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\r\n                Logger.log(\"Fail to download manifest file, hot update skipped.\");\r\n                alreadyUpFlag = true; //使用当前版本\r\n                isDownloadFail = true;\r\n                break;\r\n            case jsb.EventAssetsManager.UPDATE_PROGRESSION:\r\n                if(event && event.getMessage() == \"VersionDownloaded\")\r\n                {\r\n                    this.formatVersion();\r\n                }else if(event && event.getMessage() == \"ProjectDownloaded\")\r\n                {\r\n                    this.formatManifest();\r\n                }\r\n                return;\r\n            case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\r\n                alreadyUpFlag = true;\r\n                Logger.log(\"Already up to date with the latest remote version.\");\r\n                break;\r\n            case jsb.EventAssetsManager.NEW_VERSION_FOUND:\r\n                newVerThere = true;\r\n                break;\r\n            case jsb.EventAssetsManager.UPDATE_FINISHED:\r\n                Logger.log(\"new version found, but there are no assets changed need to download.\")\r\n                if( this._am){\r\n                    this._am.setEventCallback(null);\r\n                    this._am = null\r\n                    this._updating = false\r\n                }\r\n                let gameInfo = Global.GameData.getGameInfo(this._gameType)\r\n                Global.UI.fastTip(gameInfo.name + \"下载成功!\")\r\n                \r\n                Global.HotUpdateManager.updateNativeHotUpdateVersion(this._gameType, this._gameVersion);\r\n                Global.Event.event(GlobalEvent.UPDATE_SUB_GAME_FINISH, this._gameType);\r\n                Global.HotUpdateManager.removeHotUpdateGameComp(this._gameType, true);\r\n                this.doGameRestart();\r\n                break;\r\n            default:\r\n                return;\r\n        }\r\n        this._am.setEventCallback(null);\r\n\r\n        this._checkListener = null;\r\n        this._updating = false;\r\n        Logger.log(\"check = \", this._gameType);\r\n        let gameTypes = Global.GameData.gameTypes;\r\n\r\n        let updateHelper = Global.HotUpdateManager.updateHelper\r\n        if (alreadyUpFlag) {\r\n            Logger.log(\"更新下载过\");\r\n            if (this._gameType == gameTypes.hall) {\r\n                Logger.log(\"切大厅\");\r\n                // this._downOverFun();\r\n            } else {\r\n                Logger.log(\"切入游戏 =\", this._gameType);\r\n\r\n                if (isDownloadFail == true) {\r\n                    // this._downOverFun(4);\r\n                    Global.Event.event(GlobalEvent.UPDATE_SUB_GAME_FAILED, this._gameType)\r\n                    Global.HotUpdateManager.removeHotUpdateGameComp(this._gameType, true)\r\n                    return;\r\n                }\r\n                if (this.m_downLoadFlag) {\r\n                    // this._downOverFun(3);\r\n                    Global.HotUpdateManager.updateNativeHotUpdateVersion(this._gameType, this._gameVersion)\r\n                    Global.Event.event(GlobalEvent.UPDATE_SUB_GAME_FINISH, this._gameType)\r\n                    Global.HotUpdateManager.removeHotUpdateGameComp(this._gameType, true)\r\n                    return;\r\n                }\r\n            }\r\n        }\r\n\r\n        if (newVerThere) {\r\n            if (this.m_downLoadFlag) {\r\n                // this._downOverFun(1);\r\n                this.startVerionUpdate();\r\n                return;\r\n            }\r\n        }\r\n    }\r\n\r\n    private formatVersion()\r\n    {\r\n        let tmpVersionPath = Global.HotUpdateManager.updateHelper.genStoragePath(this._gameType + \"_temp/\") + Global.HotUpdateManager.versionCfgFileName;\r\n        if(!jsb.fileUtils.isFileExist(tmpVersionPath))\r\n        {\r\n            Logger.error(\"找不到文件\", tmpVersionPath);\r\n            return;\r\n        }\r\n        let content = jsb.fileUtils.getStringFromFile(tmpVersionPath);\r\n        let tmpVersion = JSON.parse(content);\r\n        let fullUrl = this._gameUpdateUrl + \"/\" + this._gameVersion +\"/\"+ this._gameType + \"/\";\r\n        tmpVersion.packageUrl = fullUrl;\r\n        tmpVersion.remoteManifestUrl = fullUrl + Global.HotUpdateManager.projectCfgFileName\r\n        tmpVersion.remoteVersionUrl = fullUrl + Global.HotUpdateManager.versionCfgFileName;\r\n        tmpVersion.version = this.remoteVer;\r\n\r\n\r\n        let newTmpContent = JSON.stringify(tmpVersion);\r\n        jsb.fileUtils.writeStringToFile(newTmpContent, tmpVersionPath);\r\n    }\r\n\r\n\r\n    //清理不用的资源   @todo更新url\r\n    private formatManifest()\r\n    {\r\n        if(!cc.sys.isNative)\r\n            return;\r\n        let tmpProjectPath = Global.HotUpdateManager.updateHelper.genStoragePath(this._gameType + \"_temp/\") + \"project.manifest.temp\";\r\n        if(!jsb.fileUtils.isFileExist(tmpProjectPath))\r\n        {\r\n            Logger.error(\"找不到文件\", tmpProjectPath);\r\n            return;\r\n        }\r\n        let content = jsb.fileUtils.getStringFromFile(tmpProjectPath);\r\n        let tmpManifest = JSON.parse(content);\r\n        let fullUrl =  this._gameUpdateUrl + \"/\" + this._gameVersion +\"/\"+ this._gameType + \"/\";\r\n       \r\n        tmpManifest.packageUrl = fullUrl;\r\n        tmpManifest.remoteManifestUrl = fullUrl + Global.HotUpdateManager.projectCfgFileName\r\n        tmpManifest.remoteVersionUrl = fullUrl + Global.HotUpdateManager.versionCfgFileName;\r\n        tmpManifest.version = this.remoteVer;\r\n        this.totalAssetByte = tmpManifest.totalSize\r\n        let newTmpContent = JSON.stringify(tmpManifest);\r\n        jsb.fileUtils.writeStringToFile(newTmpContent, tmpProjectPath);\r\n\r\n    }\r\n\r\n\r\n    startVerionUpdate() {\r\n        Logger.log('startVerionUpdate');\r\n        if (this._am && !this._updating) {\r\n\r\n            this._am.setEventCallback(this._updateCb.bind(this));\r\n\r\n            if (this._am.getState() === jsb.AssetsManager.State.UNINITED) {\r\n                this._am.loadLocalManifest(this._storagePath);\r\n            }\r\n            this._am.update();\r\n            this._updating = true;\r\n        } else {\r\n            Logger.log(\"--------startVerionUpdate failed------\")\r\n        }\r\n    }\r\n    _updateCb(event) {\r\n        var needRestart = false;\r\n        var failed = false;\r\n        var updateMsg = \"\";\r\n        switch (event.getEventCode()) {\r\n            case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\r\n                let reportParam0 = {\"game\":\"game_\"+this._gameType,\"eventcode\":event.getEventCode(),\"event\":\"update\",\"faildres\":event.getAssetId(),\"url\":this._gameUpdateUrl}\r\n                Global.ReportTool.ReportClientError(ReportTool.REPORT_TYPE_HOT_UPDATE_ERROR,reportParam0)\r\n                updateMsg = 'No local manifest file found, hot update skipped.';\r\n                failed = true;\r\n                break;\r\n            case jsb.EventAssetsManager.UPDATE_PROGRESSION:\r\n                let per = event.getPercent();\r\n                if(event && event.getMessage() == \"ProjectDownloaded\")\r\n                {\r\n                    this.formatManifest();\r\n                }\r\n                this._download_percent = per\r\n                Global.Event.event(GlobalEvent.UPDATE_SUB_GAME_PERCENT, this._gameType, per)\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\r\n            case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\r\n                updateMsg = 'Fail to download manifest file, hot update skipped.';\r\n                failed = true;\r\n                this.reportLog(0,ReportTool.REPORT_TYPE_DOWNLOADSUBGAME_FAILED,event.getAssetId())\r\n                break;\r\n            case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\r\n                updateMsg = 'Already up to date with the latest remote version.';\r\n                failed = true;\r\n                break;\r\n            case jsb.EventAssetsManager.UPDATE_FINISHED:\r\n                updateMsg = 'Update finished. ' + event.getMessage();\r\n                Logger.log(updateMsg);\r\n                let gameInfo = Global.GameData.getGameInfo(this._gameType)\r\n                Global.UI.fastTip(gameInfo.name + \"下载成功!\")\r\n                needRestart = true;\r\n                break;\r\n            case jsb.EventAssetsManager.UPDATE_FAILED:\r\n                updateMsg = 'Update failed. ' + event.getMessage();\r\n                Logger.log(updateMsg);\r\n                this.reportLog(0,ReportTool.REPORT_TYPE_DOWNLOADSUBGAME_FAILED,event.getAssetId())\r\n                this._updating = false;\r\n                this._canRetry = true;\r\n                this._retry();\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_UPDATING:\r\n                updateMsg = 'Asset update error: ' + event.getAssetId() + ', ' + event.getMessage();\r\n                Logger.log(updateMsg);\r\n\r\n                let reportParam3 = {\"game\":\"game_\"+this._gameType,\"eventcode\":event.getEventCode(),\"event\":\"update\",\"faildres\":event.getAssetId(),\"url\":this._gameUpdateUrl}\r\n                Global.ReportTool.ReportClientError(ReportTool.REPORT_TYPE_HOT_UPDATE_ERROR,reportParam3)\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_DECOMPRESS:\r\n                updateMsg = event.getMessage();\r\n                Logger.log(updateMsg);\r\n                let reportParam4 = {\"game\":\"game_\"+this._gameType,\"eventcode\":event.getEventCode(),\"event\":\"update\",\"faildres\":event.getAssetId(),\"url\":this._gameUpdateUrl}\r\n                Global.ReportTool.ReportClientError(ReportTool.REPORT_TYPE_HOT_UPDATE_ERROR,reportParam4)\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n\r\n        if (failed) {\r\n            this._am.setEventCallback(null);\r\n            this._updateListener = null;\r\n            this._updating = false;\r\n            Global.HotUpdateManager.gIsGameDownloading[this._gameType] = false;\r\n            Global.HotUpdateManager.removeHotUpdateGameComp(this._gameType, true)\r\n        }\r\n\r\n        if (needRestart) {\r\n            this.doGameRestart();\r\n        }\r\n    }\r\n\r\n    private doGameRestart(){\r\n        Global.HotUpdateManager.updateHelper.downloaded(this._gameType);\r\n        this._am.setEventCallback(null);\r\n        this._updateListener = null;\r\n\r\n        //非大厅的进入游戏\r\n        if (this.m_downLoadFlag) {\r\n            // this._downOverFun(3, true);\r\n            Global.Event.event(GlobalEvent.UPDATE_SUB_GAME_FINISH, this._gameType)\r\n        }\r\n        Global.HotUpdateManager.updateNativeHotUpdateVersion(this._gameType, this._gameVersion)\r\n        Global.HotUpdateManager.removeHotUpdateGameComp(this._gameType, true)\r\n        //上报PostInstallGameInfo\r\n        if (this._gameType){\r\n            let gameInfo = Global.GameData.getGameInfo(this._gameType)\r\n            if (gameInfo){\r\n                Logger.log(\"PostInstallGameInfo game_id : \" + Number(this._gameType) + \" game_name = \" + gameInfo.name )\r\n                Global.HallServer.send(NetAppface.mod,NetAppface.PostInstallGameInfo,{\"game_id\":Number(this._gameType),\"game_name\":gameInfo.name},null,null,false);\r\n                this.reportLog()\r\n            }\r\n        }\r\n    }\r\n\r\n\r\n    reportLog(result = 1,key = ReportTool.REPORT_TYPE_DOWNLOADSUBGAME_RESULT ,failedRes = \"\" ) {\r\n        let totalTime = new Date().getTime() - this.startTime\r\n        if(this.totalAssetByte && this.totalAssetByte != this.totalByte && result == 1 )\r\n        {\r\n            result = 2\r\n        }\r\n       \r\n        if(!this.totalAssetByte)\r\n        {\r\n            this.totalAssetByte = 0\r\n        }\r\n\r\n        this.totalAssetByte = Number(this.totalAssetByte) || 0\r\n        let reportParam = {\r\n            \"result\": result,\r\n            \"game\": this._gameType,\r\n            \"totalFileCount\": this.totalFileCount,\r\n            \"totalByte\": this.totalByte/1000,\r\n            \"totalTime\": totalTime / 1000,\r\n            \"downLoadType\": this.downLoadType,\r\n            \"updateUrl\": this._gameUpdateUrl,\r\n            \"startVer\": this._gameVersion,\r\n            \"totalAssetsBytes\": this.totalAssetByte/1000,\r\n            \"targetVer\": this._gameVersion,\r\n            \"retryTimes\": this.m_retryCount,\r\n            \"dun\":Global.DunHotUpdateUrlSetting.curDunType,\r\n            \"totalVerifyAssetsByte\":this.totalVerifySize/1000,\r\n            \"failedRes\":failedRes\r\n        }\r\n        if(!result)\r\n        {\r\n            Global.ReportTool.ReportClientError(key, reportParam);\r\n            return\r\n        }\r\n        Global.ReportTool.ReportPublicClientLog(key, reportParam);\r\n    }\r\n\r\n    // countAssetSize(content)\r\n    // {\r\n    //     cc.error(\"content====================\"+JSON.stringify(content))\r\n    //     if(!content)\r\n    //     {\r\n    //         return\r\n    //     }\r\n    //     let size = 0\r\n    //     for(let obj of content)\r\n    //     {\r\n    //         if(obj)\r\n    //         {\r\n    //             cc.error(\"obj.size====================\"+ obj.size)\r\n    //             cc.error(\"obj[size]====================\"+ obj[\"size\"])\r\n    //             size += obj.size\r\n    //         }\r\n    //     }\r\n    //     return size\r\n\r\n    // }\r\n\r\n    _retry() {\r\n\r\n        if (!this._updating && this._canRetry && this.m_retryCount < 3) {\r\n            this._canRetry = false;\r\n            this._am.downloadFailedAssets();\r\n            this.m_retryCount = this.m_retryCount + 1;\r\n            return;\r\n        }\r\n        if (this.m_retryCount >= 3) {\r\n            Global.UI.fastTip(\"您当前网络不稳定\")\r\n            Global.HotUpdateManager.updateHelper.clearDownloaded(this._gameType)\r\n            Global.Event.event(GlobalEvent.UPDATE_SUB_GAME_FAILED, this._gameType)\r\n            Global.HotUpdateManager.removeHotUpdateGameComp(this._gameType, true)\r\n        }\r\n    }\r\n\r\n}"]}