{"version":3,"sources":["assets\\hall\\scripts\\logic\\core\\component\\InteractPlayComp.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import ViewBase from \"../ui/ViewBase\";\r\nimport GameBasePool from \"../tool/GameBasePool\";\r\n\r\nconst InteractCfg = {\r\n    '0': { prefab: '1', soundDelay: 1, secondSoundDelay: 0, time: 2, soundNameStart: 'hall/sound/interact/hd_meigui01', soundNameEnd: null },\r\n    '1': { prefab: '2', soundDelay: 1, secondSoundDelay: 0, time: 2, soundNameStart: 'hall/sound/interact/hd_jidan01', soundNameEnd: null },\r\n    '2': { prefab: '3', soundDelay: 1, secondSoundDelay: 0, time: 2, soundNameStart: 'hall/sound/interact/hd_ganbei01', soundNameEnd: null },\r\n    '3': { prefab: '4', soundDelay: 1, secondSoundDelay: 0, time: 2, soundNameStart: 'hall/sound/interact/hd_woshou01', soundNameEnd: null },\r\n    '4': { prefab: '5', soundDelay: 1, secondSoundDelay: 0, time: 2, soundNameStart: 'hall/sound/interact/hd_daocha01', soundNameEnd: null },\r\n    '5': { prefab: '6', soundDelay: 1, secondSoundDelay: 0, time: 2, soundNameStart: 'hall/sound/interact/hd_maobi01', soundNameEnd: null },\r\n    '6': { prefab: '7', soundDelay: 1, secondSoundDelay: 0, time: 2, soundNameStart: 'hall/sound/interact/hd_bingtong01', soundNameEnd: null },\r\n    '7': { prefab: '8', soundDelay: 0, secondSoundDelay: 2, time: 2, soundNameStart: 'hall/sound/interact/hd_dapao01', soundNameEnd: 'hall/sound/interact/hd_dapao01_end' },\r\n};\r\n\r\nexport default class InteractPlayComp extends cc.Component {\r\n    private poolMap: { [key: string]: InteractPool } = {};\r\n    private playingMap: { [owner: string]: any[] } = {};\r\n    private animView: cc.Node;\r\n\r\n    onLoad() {\r\n        let poolNode = cc.find(\"pool\", this.node);\r\n        poolNode.active = false;\r\n        for (let key in InteractCfg) {\r\n            let copyNode = cc.find(`pool/${InteractCfg[key]['prefab']}`, this.node);\r\n            this.poolMap[key] = new InteractPool(poolNode, copyNode, key);\r\n        }\r\n        this.animView = cc.find(\"animView\", this.node);\r\n    }\r\n\r\n    public playAct(key: string, fWPos: cc.Vec3, tWPos: cc.Vec3, localSeat: number) {\r\n        let owner = String(localSeat);\r\n        let actionItem = this.poolMap[key].getItem();\r\n        actionItem.active = true;\r\n        actionItem.node.setParent(this.animView);\r\n\r\n        if (!this.playingMap[owner])\r\n            this.playingMap[owner] = [];\r\n        this.playingMap[owner].push(actionItem);\r\n\r\n        let soundDelay = InteractCfg[key]['soundDelay'];\r\n        let secondSoundDelay = InteractCfg[key]['secondSoundDelay'];\r\n        let time = InteractCfg[key]['time'];\r\n        actionItem.showMoveAnim(fWPos, tWPos);\r\n\r\n        let tween = new cc.Tween(actionItem.node);\r\n        tween.delay(soundDelay)\r\n            .call(() => {\r\n                if (InteractCfg[key]['soundNameStart'])\r\n                    Global.Audio.playSound(InteractCfg[key]['soundNameStart']);\r\n            })\r\n            .delay(secondSoundDelay)\r\n            .call(() => {\r\n                actionItem.showSkAnim(tWPos);\r\n                if (InteractCfg[key]['soundNameEnd']) {\r\n                    Global.Audio.playSound(InteractCfg[key]['soundNameEnd']);\r\n                }\r\n            })\r\n            .delay(time)\r\n            .call(() => {\r\n                this.poolMap[key].recycleItem(actionItem);\r\n                let index = this.playingMap[owner].indexOf(actionItem);\r\n                if (index > -1)\r\n                    this.playingMap[owner].splice(index, 1);\r\n            })\r\n            .start();\r\n    }\r\n\r\n    public clearOneOwner(owner: string) {\r\n        let itemArr = this.playingMap[owner];\r\n        if (itemArr && !Global.Toolkit.isEmptyObject(itemArr)) {\r\n            itemArr.forEach(item => {\r\n                let pool = this.poolMap[item.key];\r\n                pool.recycleItem(item);\r\n            });\r\n            this.playingMap[owner] = [];\r\n        }\r\n    }\r\n\r\n    public clearAllOwner() {\r\n        for (let owner in this.playingMap) {\r\n            this.clearOneOwner(owner);\r\n        }\r\n    }\r\n}\r\n\r\nclass InteractPool extends GameBasePool<ActionItem>{\r\n    constructor(protected root: cc.Node, private copyNode: cc.Node, private key: string) {\r\n        super(root);\r\n    }\r\n    protected get preCount() {\r\n        return 5;\r\n    }\r\n\r\n    protected get everyCount() {\r\n        return 5;\r\n    }\r\n\r\n    protected createItem() {\r\n        let node = cc.instantiate(this.copyNode);\r\n        return new ActionItem(node, this.key);\r\n    }\r\n\r\n    protected resetItem(item: ActionItem) {\r\n        item.node.setParent(this.root);\r\n        item.active = false;\r\n        item.reset();\r\n    }\r\n}\r\n\r\nclass ActionItem extends ViewBase {\r\n    private spNode: cc.Node;\r\n    private sk: sp.Skeleton;\r\n    private skstart: sp.Skeleton;\r\n    constructor(node: cc.Node, public key: string) {\r\n        super();\r\n        this.setNode(node);\r\n    }\r\n\r\n    protected initView() {\r\n        this.spNode = this.getChild('sp');\r\n        this.sk = <sp.Skeleton>this.getComponent('sk', sp.Skeleton);\r\n        this.sk.setCompleteListener(() => {\r\n            this.sk.node.active = false;\r\n        })\r\n        this.skstart = <sp.Skeleton>this.getComponent('skstart', sp.Skeleton);\r\n        this.skstart.setCompleteListener(() => {\r\n            this.skstart.node.active = false;\r\n        })\r\n    }\r\n\r\n    public showMoveAnim(fromWolrdPos: cc.Vec3, toWorldPos: cc.Vec3, time: number = 1) {\r\n        let fPos = this.spNode.parent.convertToNodeSpaceAR(fromWolrdPos);\r\n        let tPos = this.spNode.parent.convertToNodeSpaceAR(toWorldPos);\r\n        this.spNode.active = true;\r\n        this.spNode.setPosition(fPos);\r\n\r\n        this.skstart.node.setPosition(fPos);\r\n        this.skstart.node.active = true;\r\n        this.skstart.setAnimation(0, 'idle', false);\r\n\r\n        let tween = new cc.Tween(this.spNode);\r\n        tween.to(time, { position: tPos }, cc.easeCubicActionOut())\r\n            .call(() => {\r\n                this.spNode.active = false;\r\n            })\r\n            .start();\r\n    }\r\n\r\n    public showSkAnim(toWorldPos: cc.Vec3) {\r\n        let tPos = this.sk.node.parent.convertToNodeSpaceAR(toWorldPos);\r\n        this.sk.node.setPosition(tPos);\r\n        this.sk.node.active = true;\r\n        this.sk.setAnimation(0, 'idle', false);\r\n    }\r\n\r\n    public reset() {\r\n        this.spNode.stopAllActions();   // debug 回收强制停止节点所有动作\r\n        this.node.stopAllActions();\r\n        this.spNode.active = false;\r\n        this.sk.node.active = false;\r\n        this.skstart.node.active = false;\r\n        this.active = false;\r\n    }\r\n}"]}